openapi: 3.1.1
info:
  title: Energy Coordination — Coordination Attributes (v1)
  version: 1.0.0
  x-profile-id: profiles/energy-coordination/energy_coordination/v1/coordination
  description: >
    Attribute schemas for energy coordination extensions.
    These attributes extend EnergyResource, EnergyOffer, EnergyContract, and EnergyTradeDelivery
    to enable offer curve expression, objective-driven coordination, locational pricing, market clearing,
    and multi-party settlement. Used across Item.itemAttributes, Offer.offerAttributes, Order.orderAttributes,
    and Fulfillment.attributes.
    
    **Key Changes**:
    - OfferCurve replaces "bid curve" terminology (currency, minExport, maxExport, curve)

components:
  schemas:
    ########################################################################
    # COORDINATION EXTENSIONS — Shared Across Attribute Slots
    ########################################################################

    OfferCurve:
      type: object
      description: >
        Price-responsive offer curve with signed power values.
        Positive power values = providing energy to grid (injection/export).
        Negative power values = receiving energy from grid (withdrawal/consumption).
        Unified terminology replacing "bid curve".
      additionalProperties: false
      required: [currency, minExport, maxExport, curve]
      properties:
        currency:
          type: string
          description: Currency for prices (ISO 4217).
          example: "INR"
          x-jsonld: { "@id": "schema:currency" }

        minExport:
          type: number
          description: >
            Minimum export in kilowatts.
            Negative values = maximum withdrawal/consumption.
            Positive values = minimum export/generation.
          example: -11
          x-jsonld: { "@id": "beckn:minExport" }

        maxExport:
          type: number
          description: >
            Maximum export in kilowatts.
            Negative values = no export, only withdrawal.
            Positive values = maximum export/generation.
          example: 10
          x-jsonld: { "@id": "beckn:maxExport" }

        curve:
          type: array
          description: Array of price/power pairs.
          items:
            $ref: '#/components/schemas/OfferCurvePoint'
          minItems: 1
          x-jsonld: { "@id": "beckn:curve" }

    OfferCurvePoint:
      type: object
      description: A single price/power pair in an offer curve.
      additionalProperties: false
      required: [price, powerKW]
      properties:
        price:
          type: number
          minimum: 0
          description: Price per kilowatt-hour at this power level.
          example: 0.06
          x-jsonld: { "@id": "schema:price" }

        powerKW:
          type: number
          description: >
            Power level in kilowatts.
            Negative values = receiving energy (withdrawal/consumption).
            Positive values = providing energy (injection/export).
            Zero = no participation.
          example: 2.0
          x-jsonld: { "@id": "beckn:powerKW" }

    EnergyObjectives:
      type: object
      description: Structured objectives for energy resources expressing goals, constraints, and preferences.
      additionalProperties: false
      properties:
        targetChargeKWh:
          type: number
          minimum: 0
          description: Target energy to charge (for batteries, EVs).
          example: 20
          x-jsonld: { "@id": "beckn:targetChargeKWh" }
        targetGenerationKWh:
          type: number
          minimum: 0
          description: Target energy to generate (for solar, wind).
          example: 30
          x-jsonld: { "@id": "beckn:targetGenerationKWh" }
        targetReductionKW:
          type: number
          maximum: 0
          description: Target demand reduction (for demand flexibility).
          example: -50
          x-jsonld: { "@id": "beckn:targetReductionKW" }
        deadline:
          type: string
          format: date-time
          description: Deadline for achieving the objective (ISO 8601).
          example: "2024-12-15T18:00:00Z"
          x-jsonld: { "@id": "schema:endTime" }
        maxPricePerKWh:
          type: number
          minimum: 0
          description: Maximum acceptable price per kilowatt-hour.
          example: 0.12
          x-jsonld: { "@id": "beckn:maxPricePerKWh" }
        minPricePerKWh:
          type: number
          minimum: 0
          description: Optional. Minimum acceptable price per kilowatt-hour (for generators). Can also be expressed via bidCurve first point.
          example: 0.05
          x-jsonld: { "@id": "beckn:minPricePerKWh" }
        preferredSource:
          type: string
          enum: [SOLAR, BATTERY, GRID, HYBRID, RENEWABLE]
          description: Optional. Preferred energy source type. Can be expressed via discovery filters.
          example: "SOLAR"
          x-jsonld: { "@id": "beckn:preferredSource" }

    # Note: LocationalPriceAdder and GridConstraints have been moved to GridNode schema
    # See ../GridNode/v1/attributes.yaml

    ########################################################################
    # TARIFF SCHEMAS — Based on OCPI Standard
    ########################################################################

    Tariff:
      type: object
      description: >
        Comprehensive tariff structure based on OCPI standard.
        Supports time-of-use pricing, tiered rates, and utility-style tariffs.
        Can be used in SELLER roleInputs instead of pricePerKWh for fixed price mode.
      additionalProperties: false
      required: [currency, elements]
      properties:
        tariffId:
          type: string
          description: Unique tariff identifier (optional, for reference).
          example: "TARIFF-TOU-001"
          x-jsonld: { "@id": "schema:identifier" }

        currency:
          type: string
          description: Currency code (ISO 4217).
          example: "INR"
          x-jsonld: { "@id": "schema:currency" }

        type:
          type: string
          enum: [REGULAR, AD_HOC_PAYMENT, PROFILE_CHEAP, PROFILE_FAST, PROFILE_GREEN]
          description: >
            Tariff type (OCPI enum).
            REGULAR: Standard tariff
            AD_HOC_PAYMENT: One-time payment
            PROFILE_*: Profile-based tariffs
          default: "REGULAR"
          x-jsonld: { "@id": "ocpi:type" }

        tariffAltText:
          type: array
          description: Human-readable tariff description in multiple languages.
          items:
            type: object
            additionalProperties: false
            properties:
              language:
                type: string
                example: "en"
                x-jsonld: { "@id": "schema:inLanguage" }
              text:
                type: string
                example: "Time-of-Use Tariff - Peak/Off-Peak"
                x-jsonld: { "@id": "schema:text" }
          x-jsonld: { "@id": "ocpi:tariff_alt_text" }

        tariffAltUrl:
          type: string
          format: uri
          description: URL to detailed tariff information.
          example: "https://utility.com/tariffs/tou-001"
          x-jsonld: { "@id": "ocpi:tariff_alt_url" }

        minPrice:
          type: object
          description: Minimum price (excl/incl VAT).
          additionalProperties: false
          properties:
            exclVat:
              type: number
              minimum: 0
              description: Price excluding VAT.
              x-jsonld: { "@id": "ocpi:excl_vat" }
            inclVat:
              type: number
              minimum: 0
              description: Price including VAT.
              x-jsonld: { "@id": "ocpi:incl_vat" }
          x-jsonld: { "@id": "ocpi:min_price" }

        maxPrice:
          type: object
          description: Maximum price (excl/incl VAT).
          additionalProperties: false
          properties:
            exclVat:
              type: number
              minimum: 0
              x-jsonld: { "@id": "ocpi:excl_vat" }
            inclVat:
              type: number
              minimum: 0
              x-jsonld: { "@id": "ocpi:incl_vat" }
          x-jsonld: { "@id": "ocpi:max_price" }

        elements:
          type: array
          description: >
            Array of tariff elements, each defining price components and restrictions.
            Multiple elements allow time-of-use, tiered pricing, etc.
          items:
            $ref: '#/components/schemas/TariffElement'
          minItems: 1
          x-jsonld: { "@id": "ocpi:elements" }

        energyMix:
          type: object
          description: >
            Optional. Energy source information (OCPI EnergyMix).
            Specifies renewable energy percentage, carbon footprint, etc.
          additionalProperties: false
          properties:
            isGreenEnergy:
              type: boolean
              description: Whether energy is from renewable sources.
              x-jsonld: { "@id": "ocpi:is_green_energy" }
            energySources:
              type: array
              description: Array of energy sources with percentages.
              items:
                type: object
                additionalProperties: false
                properties:
                  source:
                    type: string
                    enum: [SOLAR, WIND, HYDRO, NUCLEAR, COAL, GAS, OTHER]
                    x-jsonld: { "@id": "ocpi:source" }
                  percentage:
                    type: number
                    minimum: 0
                    maximum: 100
                    x-jsonld: { "@id": "ocpi:percentage" }
              x-jsonld: { "@id": "ocpi:energy_sources" }
            environImpact:
              type: object
              description: Environmental impact metrics.
              additionalProperties: false
              properties:
                carbonDioxide:
                  type: number
                  minimum: 0
                  description: CO2 emissions in g/kWh.
                  x-jsonld: { "@id": "ocpi:carbon_dioxide" }
              x-jsonld: { "@id": "ocpi:environ_impact" }
            supplierName:
              type: string
              description: Name of energy supplier.
              x-jsonld: { "@id": "ocpi:supplier_name" }
            energyProductName:
              type: string
              description: Name of energy product.
              x-jsonld: { "@id": "ocpi:energy_product_name" }
          x-jsonld: { "@id": "ocpi:energy_mix" }

    TariffElement:
      type: object
      description: >
        A single tariff element with price components and restrictions.
        Multiple elements enable time-of-use, tiered pricing, etc.
      additionalProperties: false
      required: [priceComponents]
      properties:
        priceComponents:
          type: array
          description: Array of price components (ENERGY, TIME, FLAT, etc.).
          items:
            $ref: '#/components/schemas/TariffPriceComponent'
          minItems: 1
          x-jsonld: { "@id": "ocpi:price_components" }

        restrictions:
          type: object
          description: >
            Optional. Restrictions on when this tariff element applies.
            Enables time-of-use, day-of-week, reservation requirements, etc.
          additionalProperties: false
          properties:
            startTime:
              type: string
              pattern: '^([0-1][0-9]|2[0-3]):[0-5][0-9]$'
              description: Start time (HH:MM format, 24-hour).
              example: "06:00"
              x-jsonld: { "@id": "ocpi:start_time" }
            endTime:
              type: string
              pattern: '^([0-1][0-9]|2[0-3]):[0-5][0-9]$'
              description: End time (HH:MM format, 24-hour).
              example: "22:00"
              x-jsonld: { "@id": "ocpi:end_time" }
            dayOfWeek:
              type: array
              description: Days of week when this element applies.
              items:
                type: string
                enum: [MONDAY, TUESDAY, WEDNESDAY, THURSDAY, FRIDAY, SATURDAY, SUNDAY]
              x-jsonld: { "@id": "ocpi:day_of_week" }
            minKWh:
              type: number
              minimum: 0
              description: Minimum energy (kWh) for this tier to apply.
              x-jsonld: { "@id": "ocpi:min_kwh" }
            maxKWh:
              type: number
              minimum: 0
              description: Maximum energy (kWh) for this tier to apply.
              x-jsonld: { "@id": "ocpi:max_kwh" }
            reservation:
              type: string
              enum: [RESERVED, NOT_RESERVED]
              description: Whether reservation is required.
              x-jsonld: { "@id": "ocpi:reservation" }
          x-jsonld: { "@id": "ocpi:restrictions" }

    TariffPriceComponent:
      type: object
      description: >
        A single price component within a tariff element.
        Based on OCPI price_component structure.
      additionalProperties: false
      required: [type, price]
      properties:
        type:
          type: string
          enum: [ENERGY, TIME, FLAT, PARKING_TIME, AD_HOC_PAYMENT]
          description: >
            Price component type (OCPI enum).
            ENERGY: Per kWh pricing
            TIME: Per hour/minute pricing
            FLAT: Flat fee
            PARKING_TIME: Parking time fee
            AD_HOC_PAYMENT: One-time payment
          x-jsonld: { "@id": "ocpi:type" }

        price:
          type: number
          minimum: 0
          description: >
            Price per unit.
            For ENERGY: price per kWh
            For TIME: price per hour (or minute if step_size < 60)
            For FLAT: flat fee amount
          example: 18.0
          x-jsonld: { "@id": "schema:price" }

        vat:
          type: number
          minimum: 0
          default: 0
          description: Value-added tax percentage.
          example: 18.0
          x-jsonld: { "@id": "ocpi:vat" }

        stepSize:
          type: integer
          minimum: 1
          default: 1
          description: >
            Step size in seconds.
            For ENERGY: typically 1 (per kWh)
            For TIME: typically 3600 (per hour) or 60 (per minute)
          example: 1
          x-jsonld: { "@id": "ocpi:step_size" }

    Settlement:
      type: object
      description: Settlement information including revenue flows and billing report. Enables unambiguous multi-party billing.
      additionalProperties: false
      x-jsonld:
        "@context": ./context.jsonld
        "@type": Settlement
      properties:
        # Note: settlementCycles can be tracked in EnergyContract or EnergyTradeDelivery
        revenueFlows:
          type: array
          description: Array of revenue flow entries for multi-party settlement.
          items:
            $ref: '#/components/schemas/RevenueFlow'
          x-jsonld: { "@id": "beckn:revenueFlows" }
        settlementReport:
          $ref: '#/components/schemas/SettlementReport'
          description: Structured billing document for settlement.

    RevenueFlow:
      type: object
      description: A single revenue flow entry for a party.
      additionalProperties: false
      properties:
        party:
          $ref: '#/components/schemas/Party'
          description: Party receiving revenue.
        amount:
          type: number
          minimum: 0
          description: Revenue amount for this party.
          example: 60.0
          x-jsonld: { "@id": "schema:amount" }
        currency:
          type: string
          description: Currency code (ISO 4217).
          example: "INR"
          x-jsonld: { "@id": "schema:currency" }
        description:
          type: string
          description: Description of the revenue flow.
          example: "Energy sale (10 kWh × ₹6/kWh)"
          x-jsonld: { "@id": "schema:description" }

    Party:
      type: object
      description: Structure for party identification.
      additionalProperties: false
      properties:
        era:
          type: string
          description: Energy Resource Address of the party.
          example: "prosumer-solar-001"
          x-jsonld: { "@id": "beckn:era" }
        role:
          type: string
          enum: [SELLER, BUYER, GRID_OPERATOR, AGGREGATOR, GOVERNMENT, MARKET_CLEARING_AGENT]
          description: Role of the party in the transaction.
          example: "SELLER"
          x-jsonld: { "@id": "beckn:role" }

    SettlementReport:
      type: object
      description: Structured billing document for settlement.
      additionalProperties: false
      properties:
        reportId:
          type: string
          description: Unique identifier for the settlement report.
          example: "settle-report-2024-10-04-001"
          x-jsonld: { "@id": "beckn:reportId" }
        totalAmount:
          type: number
          minimum: 0
          description: Total settlement amount.
          example: 100.0
          x-jsonld: { "@id": "beckn:totalAmount" }
        currency:
          type: string
          description: Currency code (ISO 4217).
          example: "INR"
          x-jsonld: { "@id": "schema:currency" }
        generatedAt:
          type: string
          format: date-time
          description: Timestamp when the settlement report was generated (ISO 8601).
          example: "2024-10-04T18:30:00Z"
          x-jsonld: { "@id": "schema:dateCreated" }
        # Note: breakdown can be calculated from revenueFlows

    OffsetCommand:
      type: object
      description: Grid operator command to apply offset for flat bid curve plateaus.
      additionalProperties: false
      properties:
        offsetKW:
          type: number
          description: Power offset in kilowatts to apply. Negative values reduce setpoint, positive values increase setpoint. Presence of this property indicates the command is enabled.
          example: -2.0
          x-jsonld: { "@id": "beckn:offsetKW" }

    ########################################################################
    # AGGREGATE ACTION SCHEMAS
    ########################################################################

    AggregationRequest:
      type: object
      description: Request for bid curve aggregation and market clearing.
      additionalProperties: false
      x-jsonld:
        "@context": ./context.jsonld
        "@type": AggregationRequest
      properties:
        participants:
          type: array
          description: Array of participants with bid curves.
          items:
            $ref: '#/components/schemas/Participant'
          x-jsonld: { "@id": "beckn:participants" }
        aggregationType:
          type: string
          enum: [MARKET_CLEARING, CAPACITY_AGGREGATION]
          description: Type of aggregation.
          example: "MARKET_CLEARING"
          x-jsonld: { "@id": "beckn:aggregationType" }
        timeWindow:
          type: object
          description: Time window for aggregation.
          additionalProperties: false
          properties:
            start:
              type: string
              format: date-time
              description: Aggregation start time (ISO 8601).
              example: "2024-12-15T14:00:00Z"
              x-jsonld: { "@id": "schema:startTime" }
            end:
              type: string
              format: date-time
              description: Aggregation end time (ISO 8601).
              example: "2024-12-15T16:00:00Z"
              x-jsonld: { "@id": "schema:endTime" }
          x-jsonld: { "@id": "beckn:timeWindow" }

    Participant:
      type: object
      description: A participant in the aggregation with offer curve and optional locational pricing.
      additionalProperties: false
      properties:
        era:
          type: string
          description: Energy Resource Address of the participant.
          example: "solar-panel-001"
          x-jsonld: { "@id": "beckn:era" }
        offerCurve:
          $ref: '#/components/schemas/OfferCurve'
          description: Offer curve for this participant.
          x-jsonld: { "@id": "beckn:offerCurve" }
        # Note: locationalPriceAdder is available in GridNode schema

    AggregationResult:
      type: object
      description: Result of offer curve aggregation and market clearing.
      additionalProperties: false
      x-jsonld:
        "@context": ./context.jsonld
        "@type": AggregationResult
      properties:
        clearingPrice:
          type: number
          minimum: 0
          description: Market clearing price per kilowatt-hour.
          example: 0.075
          x-jsonld: { "@id": "beckn:clearingPrice" }
        clearingQuantityKW:
          type: number
          description: Clearing quantity in kilowatts.
          example: 50.0
          x-jsonld: { "@id": "beckn:clearingQuantityKW" }
        setpoints:
          type: array
          description: Array of setpoints for each participant.
          items:
            $ref: '#/components/schemas/Setpoint'
          x-jsonld: { "@id": "beckn:setpoints" }
        locationalPrice:
          type: number
          minimum: 0
          description: Final price including locational adder.
          example: 0.175
          x-jsonld: { "@id": "beckn:locationalPrice" }
        aggregatedSupplyCurve:
          type: array
          description: Aggregated supply curve (for reference).
          items:
            $ref: '#/components/schemas/OfferCurvePoint'
          x-jsonld: { "@id": "beckn:aggregatedSupplyCurve" }
        aggregatedDemandCurve:
          type: array
          description: Aggregated demand curve (for reference).
          items:
            $ref: '#/components/schemas/OfferCurvePoint'
          x-jsonld: { "@id": "beckn:aggregatedDemandCurve" }
        timestamp:
          type: string
          format: date-time
          description: Timestamp of the aggregation result (ISO 8601).
          example: "2024-12-15T14:00:00Z"
          x-jsonld: { "@id": "schema:dateCreated" }

    Setpoint:
      type: object
      description: Power setpoint for a resource.
      additionalProperties: false
      properties:
        era:
          type: string
          description: Energy Resource Address of the resource.
          example: "solar-panel-001"
          x-jsonld: { "@id": "beckn:era" }
        setpointKW:
          type: number
          description: Power setpoint in kilowatts. Negative for consumption, positive for generation.
          example: 3.5
          x-jsonld: { "@id": "beckn:setpointKW" }


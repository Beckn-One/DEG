openapi: 3.1.1
info:
  title: Energy Coordination — Energy Contract P2P Trade Attributes (v1)
  version: 1.0.0
  x-profile-id: profiles/energy-coordination/energy_contract_p2p_trade/v1/contract
  description: >
    Specialized contract schema for P2P energy trading use cases.
    Inherits from EnergyContract and supports two trading modes:
    
    1. **Fixed Price Mode**: SELLER + BUYER roles with fixed pricePerKWh
       - SELLER must provide: sourceMeterId, sourceType, pricePerKWh, currency
       - BUYER must provide: targetMeterId, contractedQuantity, tradeStartTime, tradeEndTime
    
    2. **Market-Based Mode**: MARKET_CLEARING_AGENT + PROSUMER roles with offer curves
       - MARKET_CLEARING_AGENT provides: marketMakingFee (required), clearingPrice, clearedPower (after market clearing)
       - PROSUMER provides: sourceMeterId, sourceType, offerCurve (required)
       - Pay-as-clear pricing: prices discovered at confirmation time after market clearing
    
    GRID_OPERATOR role (optional) provides: wheelingCharges, trade capacity info (filled in cascaded_init/cascaded_confirm).

components:
  schemas:
    ########################################################################
    # ORDER.ORDERATTRIBUTES / OFFER.OFFERATTRIBUTES — EnergyContractP2PTrade (Specialized Contract)
    ########################################################################
    EnergyContractP2PTrade:
      allOf:
        - $ref: '../EnergyContract/v1/attributes.yaml#/components/schemas/EnergyContract'
        - type: object
          description: >
            Specialized contract for P2P energy trading use cases.
            Supports two modes:
            
            **Fixed Price Mode** (SELLER + BUYER):
            - SELLER: sourceMeterId, sourceType, pricePerKWh, currency
            - BUYER: targetMeterId, contractedQuantity, tradeStartTime, tradeEndTime
            
            **Market-Based Mode** (MARKET_CLEARING_AGENT + PROSUMER):
            - MARKET_CLEARING_AGENT: marketMakingFee (required), clearingPrice, clearedPower (after clearing)
            - PROSUMER: sourceMeterId, sourceType, offerCurve (required)
            
            GRID_OPERATOR role (optional): wheelingCharges, trade capacity info (filled in cascaded_init/cascaded_confirm).
          additionalProperties: false
          x-jsonld:
            "@context": ./context.jsonld
            "@type": EnergyContractP2PTrade
          x-validation-rules:
            - rule: "Fixed Price Mode: Must contain exactly one SELLER role and one BUYER role"
              condition: "roles contains role='SELLER' and roles contains role='BUYER'"
              error: "Fixed Price Mode requires exactly one SELLER and one BUYER role"
            - rule: "Market-Based Mode: Must contain exactly one MARKET_CLEARING_AGENT role and at least one PROSUMER role"
              condition: "roles contains role='MARKET_CLEARING_AGENT' and roles contains role='PROSUMER'"
              error: "Market-Based Mode requires exactly one MARKET_CLEARING_AGENT and at least one PROSUMER role"
            - rule: "Cannot mix modes: Cannot have both SELLER/BUYER and MARKET_CLEARING_AGENT/PROSUMER in same contract"
              condition: "not (roles contains role='SELLER' and roles contains role='MARKET_CLEARING_AGENT')"
              error: "Cannot mix Fixed Price Mode (SELLER/BUYER) and Market-Based Mode (MARKET_CLEARING_AGENT/PROSUMER)"
            - rule: "GRID_OPERATOR role is optional and can be present in either mode"
              condition: "roles may contain role='GRID_OPERATOR'"
              error: null
          properties:
            roles:
              type: array
              description: >
                Roles in P2P trading contract. Supports two modes:
                - Fixed Price: SELLER + BUYER roles
                - Market-Based: MARKET_CLEARING_AGENT + PROSUMER roles
                GRID_OPERATOR role is optional for both modes.
                
                **Validation Rules**:
                - Fixed Price Mode: Must contain exactly one SELLER and one BUYER role
                - Market-Based Mode: Must contain exactly one MARKET_CLEARING_AGENT and one or more PROSUMER roles
                - GRID_OPERATOR role is optional and can be present in either mode
                - Cannot mix modes: Cannot have both (SELLER/BUYER) and (MARKET_CLEARING_AGENT/PROSUMER) in same contract
              items:
                anyOf:
                  - $ref: '#/components/schemas/P2PTradeSellerRole'
                  - $ref: '#/components/schemas/P2PTradeBuyerRole'
                  - $ref: '#/components/schemas/P2PTradeMarketClearingAgentRole'
                  - $ref: '#/components/schemas/P2PTradeProsumerRole'
                  - $ref: '#/components/schemas/P2PTradeGridOperatorRole'
                  - $ref: '../EnergyContract/v1/attributes.yaml#/components/schemas/ContractRole'
              minItems: 2
              x-jsonld: { "@id": "beckn:roles" }

    ########################################################################
    # P2P Trading Seller Role (PROSUMER)
    ########################################################################

    P2PTradeSellerRole:
      allOf:
        - $ref: '../EnergyContract/v1/attributes.yaml#/components/schemas/ContractRole'
        - type: object
          description: >
            SELLER (PROSUMER) role in P2P trading contract with predefined roleInputs structure.
            SELLER provides energy source information, pricing, and trade parameters.
          additionalProperties: false
          properties:
            role:
              type: string
              enum: [SELLER, PROSUMER]
              description: Role type must be SELLER or PROSUMER.
              example: "SELLER"
              x-jsonld: { "@id": "beckn:role" }

            roleInputs:
              type: object
              description: >
                SELLER must provide: sourceMeterId, sourceType, and ONE of:
                - pricePerKWh + currency (simple fixed price)
                - tariff (full tariff object for time-of-use, tiered pricing, utility tariffs)
                - offerCurve (market-based mode, use PROSUMER role instead)
                Optional: inverterId, certification, pricingModel, settlementType,
                minimumQuantity, maximumQuantity, validityWindow.
                Each input includes type, required, description, and nullable value.
                Note: wheelingCharges is provided by GRID_OPERATOR role, not SELLER.
                Note: pricePerKWh and tariff are mutually exclusive (use one or the other).
              additionalProperties: false
              required: [sourceMeterId, sourceType]
              # Note: Either pricePerKWh+currency OR tariff OR offerCurve should be provided, but schema allows flexibility
              properties:
                sourceMeterId:
                  $ref: '../EnergyContract/v1/attributes.yaml#/components/schemas/RoleInput'
                  description: SELLER's meter identifier (required, STRING type).

                sourceType:
                  $ref: '../EnergyContract/v1/attributes.yaml#/components/schemas/RoleInput'
                  description: >
                    Energy source type (required, STRING type).
                    Examples: SOLAR, WIND, BATTERY, HYDRO, BIOMASS.

                pricePerKWh:
                  $ref: '../EnergyContract/v1/attributes.yaml#/components/schemas/RoleInput'
                  description: >
                    Price per kilowatt-hour (NUMBER type).
                    Required for fixed price mode. Not used in market-based mode (use PROSUMER role with offerCurve instead).

                currency:
                  $ref: '../EnergyContract/v1/attributes.yaml#/components/schemas/RoleInput'
                  description: >
                    Currency code (STRING type, e.g., "USD", "INR").
                    Required for fixed price mode. Not used in market-based mode (use offerCurve.currency instead).

                tariff:
                  $ref: '../EnergyContract/v1/attributes.yaml#/components/schemas/RoleInput'
                  description: >
                    Optional. Full tariff object for time-of-use, tiered pricing, utility tariffs (OBJECT type).
                    Reference: ../EnergyCoordination/v1/attributes.yaml#/components/schemas/Tariff
                    Use instead of pricePerKWh for complex pricing structures (time-of-use, tiered rates).
                    Mutually exclusive with pricePerKWh (use one or the other).
                    Based on OCPI Tariff standard.

                offerCurve:
                  $ref: '../EnergyContract/v1/attributes.yaml#/components/schemas/RoleInput'
                  description: >
                    Optional. Offer curve for market-based trading (OBJECT type).
                    For market-based mode, use PROSUMER role with offerCurve instead of SELLER.
                    Reference: ../EnergyCoordination/v1/attributes.yaml#/components/schemas/OfferCurve

                inverterId:
                  $ref: '../EnergyContract/v1/attributes.yaml#/components/schemas/RoleInput'
                  description: Optional. Inverter identifier (STRING type).

                certification:
                  $ref: '../EnergyContract/v1/attributes.yaml#/components/schemas/RoleInput'
                  description: >
                    Optional. Certification details (OBJECT type with status and certificates array).
                    Example: {status: "Carbon Offset Certified", certificates: ["https://..."]}

                pricingModel:
                  $ref: '../EnergyContract/v1/attributes.yaml#/components/schemas/RoleInput'
                  description: >
                    Optional. Pricing model (STRING type).
                    Examples: PER_KWH, FIXED, TIME_OF_DAY.

                settlementType:
                  $ref: '../EnergyContract/v1/attributes.yaml#/components/schemas/RoleInput'
                  description: >
                    Optional. Settlement type (STRING type).
                    Examples: DAILY, HOURLY, REAL_TIME.

                minimumQuantity:
                  $ref: '../EnergyContract/v1/attributes.yaml#/components/schemas/RoleInput'
                  description: Optional. Minimum trade quantity in kWh (NUMBER type).

                maximumQuantity:
                  $ref: '../EnergyContract/v1/attributes.yaml#/components/schemas/RoleInput'
                  description: Optional. Maximum trade quantity in kWh (NUMBER type).

                validityWindow:
                  $ref: '../EnergyContract/v1/attributes.yaml#/components/schemas/RoleInput'
                  description: >
                    Optional. Offer validity window (OBJECT type with start and end DateTime).
                    Example: {start: "2024-10-04T00:00:00Z", end: "2024-10-04T23:59:59Z"}
              x-jsonld: { "@id": "beckn:roleInputs" }
              example:
                sourceMeterId:
                  type: "STRING"
                  required: true
                  description: "SELLER's meter identifier"
                  value: "100200300"
                sourceType:
                  type: "STRING"
                  required: true
                  description: "Energy source type (SOLAR, WIND, etc.)"
                  value: "SOLAR"
                pricePerKWh:
                  type: "NUMBER"
                  required: true
                  description: "Price per kilowatt-hour"
                  value: 0.15
                currency:
                  type: "STRING"
                  required: true
                  description: "Currency code (USD, INR, etc.)"
                  value: "USD"
                inverterId:
                  type: "STRING"
                  required: false
                  description: "Inverter identifier"
                  value: "inv-12345"
                certification:
                  type: "OBJECT"
                  required: false
                  description: "Certification details"
                  value:
                    status: "Carbon Offset Certified"
                    certificates:
                      - "https://example.com/certs/solar-panel-cert.pdf"
                pricingModel:
                  type: "STRING"
                  required: false
                  description: "Pricing model"
                  value: "PER_KWH"
                settlementType:
                  type: "STRING"
                  required: false
                  description: "Settlement type"
                  value: "DAILY"
                minimumQuantity:
                  type: "NUMBER"
                  required: false
                  description: "Minimum trade quantity in kWh"
                  value: 1.0
                maximumQuantity:
                  type: "NUMBER"
                  required: false
                  description: "Maximum trade quantity in kWh"
                  value: 100.0
                validityWindow:
                  type: "OBJECT"
                  required: false
                  description: "Offer validity window"
                  value:
                    start: "2024-10-04T00:00:00Z"
                    end: "2024-10-04T23:59:59Z"

    ########################################################################
    # P2P Trading Buyer Role (CONSUMER)
    ########################################################################

    P2PTradeBuyerRole:
      allOf:
        - $ref: '../EnergyContract/v1/attributes.yaml#/components/schemas/ContractRole'
        - type: object
          description: >
            BUYER (CONSUMER) role in P2P trading contract with predefined roleInputs structure.
            BUYER provides consumption requirements and trade window.
          additionalProperties: false
          properties:
            role:
              type: string
              enum: [BUYER, CONSUMER]
              description: Role type must be BUYER or CONSUMER.
              example: "BUYER"
              x-jsonld: { "@id": "beckn:role" }

            roleInputs:
              type: object
              description: >
                BUYER must provide: targetMeterId, contractedQuantity, tradeStartTime, tradeEndTime.
                Optional: preferredSourceType, preferredCertification.
                Each input includes type, required, description, and nullable value.
              additionalProperties: false
              required: [targetMeterId, contractedQuantity, tradeStartTime, tradeEndTime]
              properties:
                targetMeterId:
                  $ref: '../EnergyContract/v1/attributes.yaml#/components/schemas/RoleInput'
                  description: BUYER's meter identifier (required, STRING type).

                contractedQuantity:
                  $ref: '../EnergyContract/v1/attributes.yaml#/components/schemas/RoleInput'
                  description: >
                    Energy quantity to trade in kWh (required, NUMBER type).
                    This is the contracted amount, actual delivery may vary.

                tradeStartTime:
                  $ref: '../EnergyContract/v1/attributes.yaml#/components/schemas/RoleInput'
                  description: >
                    Start time of trade window (required, DATETIME type).
                    ISO 8601 format: "2024-10-04T10:00:00Z"

                tradeEndTime:
                  $ref: '../EnergyContract/v1/attributes.yaml#/components/schemas/RoleInput'
                  description: >
                    End time of trade window (required, DATETIME type).
                    ISO 8601 format: "2024-10-04T18:00:00Z"

                preferredSourceType:
                  $ref: '../EnergyContract/v1/attributes.yaml#/components/schemas/RoleInput'
                  description: >
                    Optional. Preferred energy source type (STRING type).
                    Examples: SOLAR, WIND, BATTERY.

                preferredCertification:
                  $ref: '../EnergyContract/v1/attributes.yaml#/components/schemas/RoleInput'
                  description: >
                    Optional. Preferred certification requirements (OBJECT type).
                    Example: {status: "Carbon Offset Certified", required: true}
              x-jsonld: { "@id": "beckn:roleInputs" }
              example:
                targetMeterId:
                  type: "STRING"
                  required: true
                  description: "BUYER's meter identifier"
                  value: "98765456"
                contractedQuantity:
                  type: "NUMBER"
                  required: true
                  description: "Energy quantity to trade in kWh"
                  value: 10.0
                tradeStartTime:
                  type: "DATETIME"
                  required: true
                  description: "Start time of trade window"
                  value: "2024-10-04T10:00:00Z"
                tradeEndTime:
                  type: "DATETIME"
                  required: true
                  description: "End time of trade window"
                  value: "2024-10-04T18:00:00Z"
                preferredSourceType:
                  type: "STRING"
                  required: false
                  description: "Preferred energy source type"
                  value: "SOLAR"
                preferredCertification:
                  type: "OBJECT"
                  required: false
                  description: "Preferred certification requirements"
                  value:
                    status: "Carbon Offset Certified"
                    required: true

    ########################################################################
    # P2P Trading Grid Operator Role
    ########################################################################

    P2PTradeGridOperatorRole:
      allOf:
        - $ref: '../EnergyContract/v1/attributes.yaml#/components/schemas/ContractRole'
        - type: object
          description: >
            GRID_OPERATOR role in P2P trading contract with predefined roleInputs structure.
            GRID_OPERATOR provides wheeling charges and trade capacity information.
            This role is filled during cascaded_init and cascaded_confirm calls.
          additionalProperties: false
          properties:
            role:
              type: string
              enum: [GRID_OPERATOR]
              description: Role type must be GRID_OPERATOR.
              example: "GRID_OPERATOR"
              x-jsonld: { "@id": "beckn:role" }

            roleInputs:
              type: object
              description: >
                GRID_OPERATOR must provide: wheelingCharges, current_buyer_trades_total, current_seller_trade_total,
                buyer_trade_cap, seller_trade_cap.
                Maximum trade volume is minimum of (buyer_trade_cap - current_buyer_trades_total) and
                (seller_trade_cap - current_seller_trade_total).
                Each input includes type, required, description, and nullable value.
              additionalProperties: false
              required: [wheelingCharges, current_buyer_trades_total, current_seller_trade_total, buyer_trade_cap, seller_trade_cap]
              properties:
                wheelingCharges:
                  $ref: '../EnergyContract/v1/attributes.yaml#/components/schemas/RoleInput'
                  description: >
                    Wheeling charges per kWh (required, NUMBER type).
                    Used in revenue flow: BUYER → GRID_OPERATOR = contractedQuantity × wheelingCharges.

                current_buyer_trades_total:
                  $ref: '../EnergyContract/v1/attributes.yaml#/components/schemas/RoleInput'
                  description: >
                    Current total of all active buyer trades for this meter in kWh (required, NUMBER type).
                    Used to calculate remaining capacity: buyer_trade_cap - current_buyer_trades_total.

                current_seller_trade_total:
                  $ref: '../EnergyContract/v1/attributes.yaml#/components/schemas/RoleInput'
                  description: >
                    Current total of all active seller trades for this meter in kWh (required, NUMBER type).
                    Used to calculate remaining capacity: seller_trade_cap - current_seller_trade_total.

                buyer_trade_cap:
                  $ref: '../EnergyContract/v1/attributes.yaml#/components/schemas/RoleInput'
                  description: >
                    Maximum allowed buyer trade volume for this meter in kWh (required, NUMBER type).
                    Based on sanctioned load or grid constraints.

                seller_trade_cap:
                  $ref: '../EnergyContract/v1/attributes.yaml#/components/schemas/RoleInput'
                  description: >
                    Maximum allowed seller trade volume for this meter in kWh (required, NUMBER type).
                    Based on generation capacity or grid constraints.
              x-jsonld: { "@id": "beckn:roleInputs" }
              example:
                wheelingCharges:
                  type: "NUMBER"
                  required: true
                  description: "Wheeling charges per kWh"
                  value: 0.025
                current_buyer_trades_total:
                  type: "NUMBER"
                  required: true
                  description: "Current total of all active buyer trades for this meter in kWh"
                  value: 5.0
                current_seller_trade_total:
                  type: "NUMBER"
                  required: true
                  description: "Current total of all active seller trades for this meter in kWh"
                  value: 20.0
                buyer_trade_cap:
                  type: "NUMBER"
                  required: true
                  description: "Maximum allowed buyer trade volume for this meter in kWh"
                  value: 50.0
                seller_trade_cap:
                  type: "NUMBER"
                  required: true
                  description: "Maximum allowed seller trade volume for this meter in kWh"
                  value: 100.0

    ########################################################################
    # P2P Trading Market Clearing Agent Role
    ########################################################################

    P2PTradeMarketClearingAgentRole:
      allOf:
        - $ref: '../EnergyContract/v1/attributes.yaml#/components/schemas/ContractRole'
        - type: object
          description: >
            MARKET_CLEARING_AGENT role in market-based P2P trading contract.
            MCA aggregates offer curves, clears the market, and provides clearing price and cleared power.
            This role is used in market-based mode (not fixed price mode).
          additionalProperties: false
          properties:
            role:
              type: string
              enum: [MARKET_CLEARING_AGENT]
              description: Role type must be MARKET_CLEARING_AGENT.
              example: "MARKET_CLEARING_AGENT"
              x-jsonld: { "@id": "beckn:role" }

            roleInputs:
              type: object
              description: >
                MARKET_CLEARING_AGENT must provide: marketMakingFee.
                After market clearing, provides: clearingPrice, clearedPower (per PROSUMER).
                Each input includes type, required, description, and nullable value.
              additionalProperties: false
              required: [marketMakingFee]
              properties:
                marketMakingFee:
                  $ref: '../EnergyContract/v1/attributes.yaml#/components/schemas/RoleInput'
                  description: >
                    Market making fee per kWh (required, NUMBER type).
                    Added to clearing price in revenue flows: (clearingPrice + marketMakingFee) × clearedPower.

                clearingPrice:
                  $ref: '../EnergyContract/v1/attributes.yaml#/components/schemas/RoleInput'
                  description: >
                    Market clearing price per kWh (NUMBER type).
                    Provided after market clearing in on_confirm. Null before clearing.

                clearedPower:
                  $ref: '../EnergyContract/v1/attributes.yaml#/components/schemas/RoleInput'
                  description: >
                    Cleared power for each PROSUMER in kW (OBJECT type, keyed by PROSUMER era or meterId).
                    Positive = export/generation, negative = withdrawal/consumption.
                    Provided after market clearing in on_confirm. Null before clearing.
                    Example: {"prosumer-001": 5.0, "prosumer-002": -8.0}
              x-jsonld: { "@id": "beckn:roleInputs" }
              example:
                marketMakingFee:
                  type: "NUMBER"
                  required: true
                  description: "Market making fee per kWh"
                  value: 0.01
                clearingPrice:
                  type: "NUMBER"
                  required: false
                  description: "Market clearing price per kWh (after clearing)"
                  value: 0.0625
                clearedPower:
                  type: "OBJECT"
                  required: false
                  description: "Cleared power per prosumer in kW (after clearing)"
                  value:
                    "prosumer-001": 5.0
                    "prosumer-002": -8.0

    ########################################################################
    # P2P Trading Prosumer Role (Market-Based)
    ########################################################################

    P2PTradeProsumerRole:
      allOf:
        - $ref: '../EnergyContract/v1/attributes.yaml#/components/schemas/ContractRole'
        - type: object
          description: >
            PROSUMER role in market-based P2P trading contract.
            PROSUMER provides offer curve expressing price/power preferences.
            Positive power = providing energy (seller), negative power = receiving energy (buyer).
            This role is used in market-based mode (not fixed price mode).
          additionalProperties: false
          properties:
            role:
              type: string
              enum: [PROSUMER]
              description: Role type must be PROSUMER.
              example: "PROSUMER"
              x-jsonld: { "@id": "beckn:role" }

            roleInputs:
              type: object
              description: >
                PROSUMER must provide: sourceMeterId, sourceType, offerCurve.
                Optional: inverterId, certification.
                Each input includes type, required, description, and nullable value.
              additionalProperties: false
              required: [sourceMeterId, sourceType, offerCurve]
              properties:
                sourceMeterId:
                  $ref: '../EnergyContract/v1/attributes.yaml#/components/schemas/RoleInput'
                  description: PROSUMER's meter identifier (required, STRING type).

                sourceType:
                  $ref: '../EnergyContract/v1/attributes.yaml#/components/schemas/RoleInput'
                  description: >
                    Energy source type (required, STRING type).
                    Examples: SOLAR, WIND, BATTERY, HYDRO, BIOMASS, CONSUMER.

                offerCurve:
                  $ref: '../EnergyContract/v1/attributes.yaml#/components/schemas/RoleInput'
                  description: >
                    Offer curve expressing price/power preferences (required, OBJECT type).
                    Positive power = providing energy (seller), negative power = receiving energy (buyer).
                    Reference: ../EnergyCoordination/v1/attributes.yaml#/components/schemas/OfferCurve
                    Structure: {currency, minExport, maxExport, curve: [{price, powerKW}]}

                inverterId:
                  $ref: '../EnergyContract/v1/attributes.yaml#/components/schemas/RoleInput'
                  description: Optional. Inverter identifier (STRING type).

                certification:
                  $ref: '../EnergyContract/v1/attributes.yaml#/components/schemas/RoleInput'
                  description: >
                    Optional. Certification details (OBJECT type with status and certificates array).
                    Example: {status: "Carbon Offset Certified", certificates: ["https://..."]}
              x-jsonld: { "@id": "beckn:roleInputs" }
              example:
                sourceMeterId:
                  type: "STRING"
                  required: true
                  description: "PROSUMER's meter identifier"
                  value: "100200300"
                sourceType:
                  type: "STRING"
                  required: true
                  description: "Energy source type (SOLAR, WIND, etc.)"
                  value: "SOLAR"
                offerCurve:
                  type: "OBJECT"
                  required: true
                  description: "Offer curve with price/power pairs"
                  value:
                    currency: "INR"
                    minExport: 0
                    maxExport: 5
                    curve:
                      - price: 0.05
                        powerKW: 0
                      - price: 0.06
                        powerKW: 2
                      - price: 0.07
                        powerKW: 5

